# Authentication Architecture

This document explains the authentication architecture of the Climate Economy Assistant backend, including how it handles both production and development modes.

## Overview

The authentication system is designed to work with Supabase JWT tokens generated by the frontend. It verifies these tokens and retrieves the corresponding user profiles from the database.

## Architecture Components

### 1. Auth Adapter (`auth_adapter.py`)

The auth adapter is the core component for token verification and user profile retrieval. It:

- Verifies JWT tokens using the Supabase JWT secret
- Checks token claims (exp, aud, etc.)
- Retrieves user profiles from the database
- Creates test profiles for development/testing

### 2. Auth Endpoints (`endpoints/auth.py`)

These endpoints handle authentication-related API requests:

- `/api/auth/status` - Get current user status and profile
- `/api/auth/test-auth` - Test endpoint for simple token verification
- `/api/auth/debug-token` - Debug endpoint for examining token contents

### 3. User Profile Manager (`utils/user_profile_manager.py`)

Helper functions for managing user profiles:

- Create new user profiles in different tables
- Retrieve profiles from the appropriate tables
- Create test profiles for debugging

### 4. Development Utilities

- `jwt_debug.py` - Decode and inspect JWT tokens
- `test_direct_auth.py` - Test basic token verification
- `test_authenticated_profile.py` - Test full auth flow with profiles
- `scripts/create_test_profile.py` - Create test profiles in the database

## Authentication Flow

1. Client sends a request with `Authorization: Bearer <token>` header
2. Backend validates the token using the JWT secret
3. If valid, it retrieves the user profile from the database
4. If in development mode and no profile exists, it creates a test profile
5. The request is then processed with the authenticated user context

## User Profiles

User profiles are stored in three separate tables:

- `job_seeker_profiles` - For job seekers
- `partner_profiles` - For partners/employers
- `admin_profiles` - For administrators

Each profile type has different permissions and access levels.

## Development vs Production

The system supports two modes:

### Production Mode

- Requires valid JWT tokens
- Requires matching user profiles in the database
- Strict validation of token claims

### Development Mode

- Can use test tokens
- Creates test profiles if needed
- More lenient validation for testing

Set `DEV_MODE=true` in environment variables to enable development mode.

## Troubleshooting

Common issues:

1. **401 Unauthorized**: Invalid or expired token
2. **404 Not Found**: Valid token but no matching user profile
3. **500 Internal Server Error**: Configuration or database issues

## Creating Test Profiles

To create a test profile for development:

```bash
python scripts/create_test_profile.py --user-id=<user_id> --profile-type=job_seeker
```

Or using a token:

```bash
python scripts/create_test_profile.py --decode-token=<jwt_token>
```

## Testing the Authentication Flow

Run the integration tests:

```bash
python test_authenticated_profile.py
```

This will ensure the entire authentication flow works properly, including token verification and profile retrieval. 